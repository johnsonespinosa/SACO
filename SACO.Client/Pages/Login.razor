@page "/login"
@using SACO.Shared.Models
@using SACO.Shared.Services
@inject IAuthService AuthService
@inject NavigationManager Navigation

<PageTitle>SACO - Login</PageTitle>

<MudContainer MaxWidth="MaxWidth.Small" Class="my-16">
    <MudCard>
        <MudCardContent>
            <MudText Typo="Typo.h4" Class="text-center mb-4">Iniciar Sesión - SACO</MudText>
            
            <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin">
                <MudGrid>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_loginModel.UserName" 
                                     Label="Nombre de Usuario"
                                     Required="true"
                                     Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudTextField @bind-Value="_loginModel.Password"
                                     Label="Contraseña"
                                     Required="true"
                                     InputType="InputType.Password"
                                     Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudCheckBox @bind-Value="_loginModel.RememberMe" 
                                    Label="Recordarme" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  ButtonType="ButtonType.Submit"
                                  FullWidth="true"
                                  Disabled="@_isLoading">
                            @if (_isLoading)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <MudText Class="ml-2">Iniciando sesión...</MudText>
                            }
                            else
                            {
                                <MudText>Iniciar Sesión</MudText>
                            }
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </EditForm>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mt-4">
                    @_errorMessage
                </MudAlert>
            }

            <MudDivider Class="my-4" />
            <MudText Typo="Typo.body2" Class="text-center">
                ¿No tienes cuenta? <MudLink Href="/register">Regístrate aquí</MudLink>
            </MudText>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private LoginRequest _loginModel = new();
    private bool _isLoading;
    private string? _errorMessage;

    private async Task HandleLogin()
    {
        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            var result = await AuthService.LoginAsync(_loginModel);
            if (result.Success)
            {
                Navigation.NavigateTo("/", forceLoad: true);
            }
            else
            {
                _errorMessage = result.Errors.FirstOrDefault() ?? "Error al iniciar sesión";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error de conexión: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }
}